SELECT       TO_CHAR(C.NR_NEGOCIO) as NR_SEQCOMI,
N.DT_MOVIMENTO AS DT_STAMP,
C.NR_NEGOCIO,
C.CD_NEGOCIO AS CODNEG,
' ' AS SERPAP,
'1' AS TP_REGISTRO,
C.DT_NEGOCIO,
N.TP_MERCADO AS CD_MERCADO,
C.QT_QTDESP,
C.CD_CLIENTE,
C.CD_NATOPE,
TO_CHAR(N.DT_MOVIMENTO,'YYYY/MM/DD HH24:MI:SS') as DT_STAMP_N,
TO_CHAR(N.HH_NEGOCIO) as HR_NEGOCIO,
TO_CHAR(N.CD_OPERA_MEGA) AS CD_CANAL,
N.IN_AFTERM AS IN_AFTER,
N.VL_NEGOCIO AS PR_NEGOCIO,
N.CD_CLIENTE as CD_CONTRAPARTE,
N.CD_CONTRAPARTE as CD_CORRET,
G.NM_CLIENTE,
L.NM_CORRET AS NM_CONTRAPARTE,
D.NM_EMIT_ORDEM,
TO_CHAR(E.CD_CPFCGC_EMIT,'FM99999999999999999999') CD_CPFCGC_EMIT,
'BOLSA' AS MERCADO
FROM   TORCOMI C
JOIN TORNEGD N      ON 
(C.NR_NEGOCIO = N.NR_NEGOCIO 
AND C.DV_NEGOCIO = N.DV_NEGOCIO
AND C.DT_NEGOCIO = N.DT_PREGAO
AND C.CD_NATOPE = N.CD_NATOPE
AND C.CD_NEGOCIO = N.CD_NEGOCIO)      
join TSCCLIBOL B      on (C.CD_CLIENTE = B.CD_CLIENTE)      
join TSCCLIGER G      on (b.CD_CPFCGC = g.cd_cpfcgc)      
join TORMOVD D      on ( D.NR_SEQORD = C.NR_SEQORD      
and D.CD_NEGOCIO = C.CD_NEGOCIO      
and D.DT_DATORD = C.DT_NEGOCIO      
and D.CD_CLIENTE = C.CD_CLIENTE      
and D.CD_NATOPE = C.CD_NATOPE)      
join  TSCEMITORDEM  E      
on(  E.CD_CPFCGC     = b.CD_CPFCGC      
and  E.DT_NASC_FUND  = b.DT_NASC_FUND      
and  E.CD_CON_DEP    = b.CD_CON_DEP      
and  E.CD_SISTEMA    = 'BOL'      
AND  E.NM_EMIT_ORDEM   = D.NM_EMIT_ORDEM )      
left join TMFCORRET  L      on(L.cd_corret = N.cd_contraparte)         
WHERE      N.DT_MOVIMENTO >= TO_DATE('{0}','YYYY/MM/DD')      
AND C.CD_CLIENTE_BRO IN (41090)      
AND N.TP_MERCADO='VIS'
UNION
SELECT       TO_CHAR(C.NR_NEGOCIO) as NR_SEQCOMI,
N.DT_MOVIMENTO AS DT_STAMP,
C.NR_NEGOCIO,
SUBSTR(C.CD_NEGOCIO,1,4) AS CODNEG,
SUBSTR(C.CD_NEGOCIO,5,3) AS SERPAP,
'1' AS TP_REGISTRO,
C.DT_NEGOCIO,
N.TP_MERCADO AS CD_MERCADO,
C.QT_QTDESP,
C.CD_CLIENTE,
C.CD_NATOPE,
TO_CHAR(N.DT_MOVIMENTO,'YYYY/MM/DD HH24:MI:SS') as DT_STAMP_N,
TO_CHAR(N.HH_NEGOCIO) as HR_NEGOCIO,
TO_CHAR(N.CD_OPERA_MEGA) AS CD_CANAL,
N.IN_AFTERM AS IN_AFTER,
N.VL_NEGOCIO AS PR_NEGOCIO,
N.CD_CLIENTE as CD_CONTRAPARTE,
N.CD_CONTRAPARTE as CD_CORRET,
G.NM_CLIENTE,
L.NM_CORRET AS NM_CONTRAPARTE,
D.NM_EMIT_ORDEM,
TO_CHAR(E.CD_CPFCGC_EMIT,'FM99999999999999999999') CD_CPFCGC_EMIT,
'BOLSA' AS MERCADO
FROM   TORCOMI C
JOIN TORNEGD N      ON 
(C.NR_NEGOCIO = N.NR_NEGOCIO 
AND C.DV_NEGOCIO = N.DV_NEGOCIO
AND C.DT_NEGOCIO = N.DT_PREGAO
AND C.CD_NATOPE = N.CD_NATOPE
AND C.CD_NEGOCIO = N.CD_NEGOCIO)      
join TSCCLIBOL B      on (C.CD_CLIENTE = B.CD_CLIENTE)      
join TSCCLIGER G      on (b.CD_CPFCGC = g.cd_cpfcgc)      
join TORMOVD D      on ( D.NR_SEQORD = C.NR_SEQORD      
and D.CD_NEGOCIO = C.CD_NEGOCIO      
and D.DT_DATORD = C.DT_NEGOCIO      
and D.CD_CLIENTE = C.CD_CLIENTE      
and D.CD_NATOPE = C.CD_NATOPE)      
join  TSCEMITORDEM  E      
on(  E.CD_CPFCGC     = b.CD_CPFCGC      
and  E.DT_NASC_FUND  = b.DT_NASC_FUND      
and  E.CD_CON_DEP    = b.CD_CON_DEP      
and  E.CD_SISTEMA    = 'BOL'      
AND  E.NM_EMIT_ORDEM   = D.NM_EMIT_ORDEM )      
left join TMFCORRET  L      on(L.cd_corret = N.cd_contraparte)         
WHERE      N.DT_MOVIMENTO >= TO_DATE('{0}','YYYY/MM/DD')      
AND C.CD_CLIENTE_BRO IN (41090)      
AND N.TP_MERCADO IN ('OPC','OPV','EOC','EOV')
UNION
SELECT       TO_CHAR(C.NR_SEQCOMI) as NR_SEQCOMI,
      N.DT_STAMP,
      C.NR_NEGOCIO,
      C.CD_COMMOD AS CODNEG,
      C.CD_SERIE AS SERPAP,
      TO_CHAR(C.TP_REGISTRO),
      C.DT_NEGOCIO,
      C.CD_MERCAD,
      C.QT_QTDESP,
      C.CD_CLIENTE,
      C.CD_NATOPE,
      TO_CHAR(N.DT_STAMP,'YYYY/MM/DD HH24:MI:SS') as DT_STAMP_N,
      TO_CHAR(N.HR_NEGOCIO)||':00' as HR_NEGOCIO,
      N.CD_CANAL,
      N.IN_AFTER,
      N.PR_NEGOCIO,
      N.CD_CLIENTE AS CD_CONTRAPARTE,
      N.CD_CONTRAPAR as CD_CORRET,
      G.NM_CLIENTE,
      L.NM_CORRET AS NM_CONTRAPARTE ,
      D.NM_EMIT_ORDEM,
      TO_CHAR(E.CD_CPFCGC_EMIT,'FM99999999999999999999') CD_CPFCGC_EMIT,
      'BMF' AS MERCADO
      FROM       tmfcomi C
	  JOIN tmfnegos N      ON (C.NR_NEGOCIO = N.NR_NEGOCIO      
and C.TP_REGISTRO = N.TP_REGISTRO      
and C.DT_NEGOCIO = N.DT_PREGAO      
and C.CD_NATOPE = N.CD_NATOPE      
and C.CD_NEGOCIO = N.CD_NEGOCIO      
and N.CD_OPERADOR = '###')      
join tscclibmf B      on (C.CD_CLIENTE = B.CODCLI)      
join tsccliger G      on (b.CD_CPFCGC = g.cd_cpfcgc)      
join tmfserie P      on(P.CD_SERIE = C.CD_SERIE)      
and P.CD_COMMOD = C.CD_COMMOD      
and p.CD_MERCAD = C.CD_MERCAD      
and P.DT_VENC >= C.DT_NEGOCIO      
join tmfmovd D      on ( D.NR_SEQORD = C.NR_SEQORD      
and D.CD_NEGOCIO = C.CD_NEGOCIO      
and D.DT_DATORD = C.DT_NEGOCIO      
and D.CD_CLIENTE = C.CD_CLIENTE      
and D.CD_NATOPE = C.CD_NATOPE)      
join  TSCEMITORDEM  E      on(  E.CD_CPFCGC     = b.CD_CPFCGC      
and  E.DT_NASC_FUND  = b.DT_NASC_FUND      
and  E.CD_CON_DEP    = b.CD_CON_DEP      
and  E.CD_SISTEMA    = 'BMF'      
and  E.NR_SEQ_EMIT   = D.NR_SEQ_EMIT )
left join TMFCORRET  L  on(L.cd_corret = N.cd_contrapar)
left join TMFOPERA J on (J.CD_OPERA_BMF = N.CD_OPERADOR)
left join TGEUSUARIO U on (U.CD_USUARIO = J.CD_OPERADOR)
WHERE       C.NR_SEQCOMI > 0        
and C.CD_CLIENTE IN (41090)      
and C.TP_REGISTRO IN (1,2,3)      
and N.DT_STAMP >= TO_DATE('{1}','YYYY/MM/DD HH24:MI:SS')